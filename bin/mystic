#!/usr/bin/env ruby

require_relative "../lib/mystic.rb"
require_relative "../lib/mystic/command_line"
require_relative "../lib/mystic/root"
require "irb"

# Examples:
# mystic create migration InitialMigration
# mystic migrate development
# mystic rollback production

ErrorOutput = Class.new StandardError
EMPTY = :empty

ARGV.map! do |arg|
  case
  when arg.empty? then EMPTY
  when arg.nil? then EMPTY
  when arg.numeric? then arg.to_f
  else arg end
end

begin
  case ARGV[0].to_sym
  when :create
    case ARGV[1].to_sym
    when :migration
      raise ErrorOutput, "No migration name provided" if ARGV[2] == EMPTY
      Mystic::CommandLine.create_migration ARGV[2].dup
    end
  when :work
    # mystic work myqueue 5 6
    # mystic work <queue_name> <wait timeout> <concurrency>
    Mystic::CommandLine.work ARGV[1], ARGV[2], ARGV[3]
  else
    begin
      Mystic.connect ARGV[1]
      case ARGV[0].to_sym
      when :migrate
	      Mystic::CommandLine.migrate
      when :rollback
	      Mystic::CommandLine.rollback
      when :console
        puts "Starting Mystic console: #{Mystic.config.env}"
        ARGV.clear
        IRB.start
      end
      Mystic.disconnect
    rescue => e
      puts e.message
    end
  end
rescue ErrorOutput => e
  puts e.message
rescue Mystic::RootError
  puts "Not in an application anymore."
end
